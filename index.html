<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>E-Commerce Returns DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-4 max-w-4xl">
    <h1 class="text-3xl font-bold text-center mb-6">E-Commerce Returns Management</h1>

    <!-- Wallet Connect -->
    <div class="text-center mb-6">
      <button id="connectWallet" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
        Connect MetaMask
      </button>
      <p id="walletStatus" class="mt-2 text-gray-700">Wallet not connected</p>
    </div>

    <!-- Initiate Return -->
    <div class="bg-white p-6 rounded shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">Initiate Return</h2>
      <input id="orderId" type="number" placeholder="Order ID" class="border p-2 mb-2 w-full" />
      <input id="itemId" type="number" placeholder="Item ID" class="border p-2 mb-2 w-full" />
      <input id="refundAmount" type="number" step="any" placeholder="Refund Amount (tokens)" class="border p-2 mb-2 w-full" />
      <input id="trackingNumber" type="text" placeholder="Tracking Number" class="border p-2 mb-2 w-full" />
      <button id="initiateReturn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Submit Return</button>
    </div>

    <!-- Check Return -->
    <div class="bg-white p-6 rounded shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">Check Return</h2>
      <input id="returnIdInput" type="text" placeholder="Return ID (0x...)" class="border p-2 mb-2 w-full" />
      <button id="checkReturn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Check</button>
      <div id="returnDetails" class="mt-4 text-gray-800"></div>
    </div>

    <!-- Admin Actions -->
    <div class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">Admin Actions (Owner Only)</h2>
      <input id="adminReturnId" type="text" placeholder="Return ID (0x...)" class="border p-2 mb-2 w-full" />
      <button id="markReceived" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded mr-2">Mark Received</button>
      <button id="processRefund" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded mr-2">Process Refund</button>
      <button id="rejectReturn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">Reject Return</button>
    </div>
  </div>

  <script>
    const contractAddress = "0x675De888122e0834d84101Dd44A3C02AE4462060"; // Replace with your deployed contract address
    const expectedChainId = "0xaa36a7"; // Sepolia testnet
    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_returnId",
				"type": "bytes32"
			}
		],
		"name": "cancelReturn",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_orderId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_itemId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_refundAmount",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "_trackingNumber",
				"type": "string"
			}
		],
		"name": "initiateReturn",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_returnId",
				"type": "bytes32"
			}
		],
		"name": "markItemReceived",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_refundTokenAddress",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "_initialOwner",
				"type": "address"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_returnId",
				"type": "bytes32"
			}
		],
		"name": "processRefund",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "returnId",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "RefundSent",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_returnId",
				"type": "bytes32"
			}
		],
		"name": "rejectReturn",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "returnId",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "orderId",
				"type": "uint256"
			}
		],
		"name": "ReturnInitiated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "returnId",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"internalType": "enum ECommerceReturns.ReturnStatus",
				"name": "newStatus",
				"type": "uint8"
			}
		],
		"name": "ReturnStatusUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "returnId",
				"type": "bytes32"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "newTrackingNumber",
				"type": "string"
			}
		],
		"name": "TrackingNumberUpdated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_returnId",
				"type": "bytes32"
			},
			{
				"internalType": "string",
				"name": "_newTrackingNumber",
				"type": "string"
			}
		],
		"name": "updateTrackingNumber",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_returnId",
				"type": "bytes32"
			}
		],
		"name": "getReturnRequestDetails",
		"outputs": [
			{
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "orderId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "itemId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "refundAmount",
				"type": "uint256"
			},
			{
				"internalType": "enum ECommerceReturns.ReturnStatus",
				"name": "status",
				"type": "uint8"
			},
			{
				"internalType": "uint256",
				"name": "initiatedTimestamp",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "trackingNumber",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "refundToken",
		"outputs": [
			{
				"internalType": "contract IERC20",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"name": "returnExists",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    let web3;
    let userAccount;
    let contract;

    const statusMap = [
      "Initiated", "ShippedBack", "ReceivedBySeller",
      "RefundProcessed", "Rejected", "Cancelled"
    ];

    async function connectWallet() {
      if (!window.ethereum) {
        alert("Install MetaMask to use this DApp");
        return;
      }

      web3 = new Web3(window.ethereum);
      const chainId = await ethereum.request({ method: "eth_chainId" });
      if (chainId !== expectedChainId) {
        alert("Switch to Sepolia testnet.");
        return;
      }

      const accounts = await ethereum.request({ method: "eth_requestAccounts" });
      userAccount = accounts[0];
      contract = new web3.eth.Contract(contractABI, contractAddress);

      document.getElementById("walletStatus").innerText =
        `Connected: ${userAccount.slice(0, 6)}...${userAccount.slice(-4)}`;
      document.getElementById("connectWallet").innerText = "Connected";
      document.getElementById("connectWallet").disabled = true;
    }

    async function initiateReturn() {
      const orderId = document.getElementById("orderId").value;
      const itemId = document.getElementById("itemId").value;
      const refundAmountEth = document.getElementById("refundAmount").value;
      const refundAmount = web3.utils.toWei(refundAmountEth, 'ether'); // Convert to Wei
      const trackingNumber = document.getElementById("trackingNumber").value;

      try {
        const tx = await contract.methods
          .initiateReturn(orderId, itemId, refundAmount, trackingNumber)
          .send({ from: userAccount });

        const returnId = tx.events?.ReturnInitiated?.returnValues?.returnId;

        if (returnId) {
          alert("Return initiated. Return ID: " + returnId);
        } else {
          alert("Return initiated, but Return ID not found in events.");
        }
      } catch (e) {
        console.error(e);
        alert("Error initiating return");
      }
    }

    async function checkReturn() {
      const returnId = document.getElementById("returnIdInput").value;
      try {
        const data = await contract.methods.getReturnRequestDetails(returnId).call();
        const html = `
          <p><strong>Buyer:</strong> ${data.buyer}</p>
          <p><strong>Order ID:</strong> ${data.orderId}</p>
          <p><strong>Item ID:</strong> ${data.itemId}</p>
          <p><strong>Refund Amount:</strong> ${web3.utils.fromWei(data.refundAmount, 'ether')} tokens</p>
          <p><strong>Status:</strong> ${statusMap[data.status]}</p>
          <p><strong>Tracking:</strong> ${data.trackingNumber}</p>
          <p><strong>Initiated:</strong> ${new Date(data.initiatedTimestamp * 1000).toLocaleString()}</p>
        `;
        document.getElementById("returnDetails").innerHTML = html;
      } catch (err) {
        alert("Invalid return ID or failed to fetch.");
        console.error(err);
      }
    }

    async function markItemReceived() {
      const returnId = document.getElementById("adminReturnId").value;
      try {
        await contract.methods.markItemReceived(returnId).send({ from: userAccount });
        alert("Item marked as received.");
      } catch (e) {
        alert("Error marking item received.");
        console.error(e);
      }
    }

    async function processRefund() {
      const returnId = document.getElementById("adminReturnId").value;
      try {
        await contract.methods.processRefund(returnId).send({ from: userAccount });
        alert("Refund processed.");
      } catch (e) {
        alert("Error processing refund.");
        console.error(e);
      }
    }

    async function rejectReturn() {
      const returnId = document.getElementById("adminReturnId").value;
      try {
        await contract.methods.rejectReturn(returnId).send({ from: userAccount });
        alert("Return rejected.");
      } catch (e) {
        alert("Error rejecting return.");
        console.error(e);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("connectWallet").addEventListener("click", connectWallet);
      document.getElementById("initiateReturn").addEventListener("click", initiateReturn);
      document.getElementById("checkReturn").addEventListener("click", checkReturn);
      document.getElementById("markReceived").addEventListener("click", markItemReceived);
      document.getElementById("processRefund").addEventListener("click", processRefund);
      document.getElementById("rejectReturn").addEventListener("click", rejectReturn);
    });
  </script>
</body>
</html>
